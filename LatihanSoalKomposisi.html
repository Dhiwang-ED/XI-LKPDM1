<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latihan Fungsi Komposisi - Kelas 11 SMA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">Latihan Fungsi Komposisi</h1>
            <p class="text-lg text-gray-600">Kelas 11 SMA • KKM: 70</p>
        </div>

        <!-- Function Type Selection -->
        <div id="functionTypeSelection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Pilih Bentuk Fungsi yang Ingin Dilatih:</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" name="functionType" value="linear" class="mr-3 w-4 h-4 text-indigo-600">
                    <span class="text-gray-700">Fungsi Linear: $f(x) = ax + b$</span>
                </label>
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" name="functionType" value="quadratic" class="mr-3 w-4 h-4 text-indigo-600">
                    <span class="text-gray-700">Fungsi Kuadrat: $f(x) = ax^2 + bx + c$</span>
                </label>
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" name="functionType" value="rational" class="mr-3 w-4 h-4 text-indigo-600">
                    <span class="text-gray-700">Fungsi Rasional: $f(x) = \frac{ax + b}{cx + d}$</span>
                </label>
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" name="functionType" value="exponential" class="mr-3 w-4 h-4 text-indigo-600">
                    <span class="text-gray-700">Fungsi Eksponensial: $f(x) = a^x$</span>
                </label>
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" name="functionType" value="radical" class="mr-3 w-4 h-4 text-indigo-600">
                    <span class="text-gray-700">Fungsi Akar: $f(x) = \sqrt{ax + b}$</span>
                </label>
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" name="functionType" value="mixed" class="mr-3 w-4 h-4 text-indigo-600">
                    <span class="text-gray-700">Campuran Semua Jenis</span>
                </label>
            </div>
            <button onclick="generateQuestions()" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                Generate 10 Soal
            </button>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="hidden">
            <!-- Generate New Questions Button -->
            <div class="text-center mb-6">
                <button onclick="generateQuestions()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                    🔄 Generate Soal Baru
                </button>
            </div>
            


            <!-- Questions -->
            <div id="questionsContainer"></div>

            <!-- Submit Button -->
            <div class="text-center mt-8">
                <button onclick="submitQuiz()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-lg text-lg transition-colors">
                    Submit Jawaban
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="hidden bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold text-center mb-6" id="resultTitle"></h2>
            <div class="text-center mb-8">
                <div class="text-6xl font-bold mb-2" id="scoreDisplay"></div>
                <div class="text-xl text-gray-600" id="scoreText"></div>
            </div>
            <div id="detailedResults"></div>
            <div class="text-center mt-8">
                <button onclick="resetQuiz()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg mr-4 transition-colors">
                    Ulangi Latihan
                </button>
                <button onclick="generateQuestions()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                    Generate Soal Baru
                </button>
            </div>
        </div>

        <!-- Virtual Keyboard -->
        <div id="virtualKeyboard" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-xl shadow-2xl p-4 hidden z-50 border-2 border-gray-200 max-w-md">
            <!-- Variables and Basic Operations -->
            <div class="mb-3">
                <div class="text-xs text-gray-500 mb-1 font-medium">Variabel & Operasi Dasar</div>
                <div class="grid grid-cols-8 gap-1">
                    <button class="kb-btn kb-variable" onclick="insertSymbol('x')">x</button>
                    <button class="kb-btn kb-variable" onclick="insertSymbol('y')">y</button>
                    <button class="kb-btn kb-operation" onclick="insertSymbol('+')">+</button>
                    <button class="kb-btn kb-operation" onclick="insertSymbol('−')">−</button>
                    <button class="kb-btn kb-operation" onclick="insertSymbol('×')">×</button>
                    <button class="kb-btn kb-operation" onclick="insertSymbol('⋅')">⋅</button>
                    <button class="kb-btn kb-operation" onclick="insertSymbol('/')">÷</button>
                    <button class="kb-btn kb-operation" onclick="insertSymbol('±')">±</button>
                </div>
            </div>
            
            <!-- Numbers -->
            <div class="mb-3">
                <div class="text-xs text-gray-500 mb-1 font-medium">Angka</div>
                <div class="grid grid-cols-5 gap-1">
                    <button class="kb-btn kb-number" onclick="insertSymbol('1')">1</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('2')">2</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('3')">3</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('4')">4</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('5')">5</button>
                </div>
                <div class="grid grid-cols-5 gap-1 mt-1">
                    <button class="kb-btn kb-number" onclick="insertSymbol('6')">6</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('7')">7</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('8')">8</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('9')">9</button>
                    <button class="kb-btn kb-number" onclick="insertSymbol('0')">0</button>
                </div>
            </div>
            
            <!-- Brackets and Powers -->
            <div class="mb-3">
                <div class="text-xs text-gray-500 mb-1 font-medium">Kurung & Pangkat</div>
                <div class="grid grid-cols-6 gap-1">
                    <button class="kb-btn kb-bracket" onclick="insertSymbol('(')">(</button>
                    <button class="kb-btn kb-bracket" onclick="insertSymbol(')')">)</button>
                    <button class="kb-btn kb-power" onclick="insertSymbol('^')">x^n</button>
                    <button class="kb-btn kb-power" onclick="insertSymbol('^2')">x²</button>
                    <button class="kb-btn kb-power" onclick="insertSymbol('^3')">x³</button>
                    <button class="kb-btn kb-function" onclick="insertSymbol('sqrt')">√</button>
                </div>
            </div>
            
            <!-- Special Symbols -->
            <div class="mb-3">
                <div class="text-xs text-gray-500 mb-1 font-medium">Simbol Khusus</div>
                <div class="grid grid-cols-6 gap-1">
                    <button class="kb-btn kb-special" onclick="insertSymbol('π')">π</button>
                    <button class="kb-btn kb-special" onclick="insertSymbol('∞')">∞</button>
                    <button class="kb-btn kb-special" onclick="insertSymbol('≠')">≠</button>
                    <button class="kb-btn kb-special" onclick="insertSymbol('≤')">≤</button>
                    <button class="kb-btn kb-special" onclick="insertSymbol('≥')">≥</button>
                    <button class="kb-btn kb-special" onclick="insertSymbol('.')">.</button>
                </div>
            </div>
            
            <!-- Control Buttons -->
            <div class="grid grid-cols-3 gap-2">
                <button class="kb-btn bg-yellow-500 hover:bg-yellow-600 text-white font-medium" onclick="backspaceInput()">⌫</button>
                <button class="kb-btn bg-red-500 hover:bg-red-600 text-white font-medium" onclick="clearInput()">Clear</button>
                <button class="kb-btn bg-gray-500 hover:bg-gray-600 text-white font-medium" onclick="hideKeyboard()">Tutup</button>
            </div>
        </div>
    </div>

    <style>
        .kb-btn {
            @apply border border-gray-300 rounded px-2 py-2 text-sm font-medium transition-all duration-200 min-h-[36px] flex items-center justify-center;
        }
        
        .kb-variable {
            @apply bg-blue-100 hover:bg-blue-200 text-blue-800 border-blue-300;
        }
        
        .kb-operation {
            @apply bg-green-100 hover:bg-green-200 text-green-800 border-green-300;
        }
        
        .kb-number {
            @apply bg-gray-100 hover:bg-gray-200 text-gray-800 border-gray-300;
        }
        
        .kb-bracket {
            @apply bg-purple-100 hover:bg-purple-200 text-purple-800 border-purple-300;
        }
        
        .kb-power {
            @apply bg-orange-100 hover:bg-orange-200 text-orange-800 border-orange-300;
        }
        
        .kb-function {
            @apply bg-indigo-100 hover:bg-indigo-200 text-indigo-800 border-indigo-300;
        }
        
        .kb-special {
            @apply bg-pink-100 hover:bg-pink-200 text-pink-800 border-pink-300;
        }
        
        .math-input {
            font-family: 'Times New Roman', serif;
            font-size: 18px;
            line-height: 1.4;
            letter-spacing: 0.5px;
        }
        
        .question-card {
            transition: all 0.3s ease;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
        }
        
        #virtualKeyboard {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>

    <script>
        let questions = [];
        let answers = [];
        let currentInputField = null;
        let selectedFunctionTypes = [];

        const functionGenerators = {
            linear: () => {
                // Variasi lebih banyak untuk koefisien dan konstanta
                const variations = [
                    // Variasi 1: Koefisien kecil
                    () => ({
                        a1: Math.floor(Math.random() * 3) + 1,
                        b1: Math.floor(Math.random() * 6) - 3,
                        a2: Math.floor(Math.random() * 3) + 1,
                        b2: Math.floor(Math.random() * 6) - 3
                    }),
                    // Variasi 2: Koefisien sedang
                    () => ({
                        a1: Math.floor(Math.random() * 5) + 1,
                        b1: Math.floor(Math.random() * 10) - 5,
                        a2: Math.floor(Math.random() * 5) + 1,
                        b2: Math.floor(Math.random() * 10) - 5
                    }),
                    // Variasi 3: Koefisien besar
                    () => ({
                        a1: Math.floor(Math.random() * 8) + 2,
                        b1: Math.floor(Math.random() * 16) - 8,
                        a2: Math.floor(Math.random() * 6) + 1,
                        b2: Math.floor(Math.random() * 12) - 6
                    }),
                    // Variasi 4: Koefisien negatif
                    () => ({
                        a1: -(Math.floor(Math.random() * 4) + 1),
                        b1: Math.floor(Math.random() * 8) - 4,
                        a2: Math.floor(Math.random() * 4) + 1,
                        b2: Math.floor(Math.random() * 8) - 4
                    })
                ];
                
                const selectedVariation = variations[Math.floor(Math.random() * variations.length)]();
                const {a1, b1, a2, b2} = selectedVariation;
                
                // Helper function to format coefficient
                const formatCoeff = (coeff) => {
                    if (coeff === 1) return '';
                    if (coeff === -1) return '-';
                    return coeff;
                };
                
                // Helper function to format sign and number
                const formatSign = (num) => {
                    if (num === 0) return '';
                    if (num > 0) return ` + ${num}`;
                    if (num < 0) return ` - ${Math.abs(num)}`;
                    return '';
                };
                
                const f = `${formatCoeff(a1)}x${formatSign(b1)}`;
                const g = `${formatCoeff(a2)}x${formatSign(b2)}`;
                
                // (f∘g)(x) = f(g(x)) = a1(a2x + b2) + b1 = a1*a2*x + a1*b2 + b1
                const compositeCoeff = a1 * a2;
                const compositeConst = a1 * b2 + b1;
                const answer = `${formatCoeff(compositeCoeff)}x${formatSign(compositeConst)}`;
                
                // Detailed steps with proper sign handling
                const distributedTerm = a1 * b2;
                
                // Create distribution step - only show multiplication if b2 is not zero
                let distributionStep = `= ${formatCoeff(a1)} \\cdot ${formatCoeff(a2)}x`;
                if (b2 !== 0) {
                    distributionStep += ` + ${formatCoeff(a1)} \\cdot ${b2}`;
                }
                if (b1 !== 0) {
                    distributionStep += `${formatSign(b1)}`;
                }
                
                // Show sign simplification if needed
                let simplificationStep = '';
                if (distributedTerm !== 0 && b1 !== 0) {
                    if (distributedTerm > 0 && b1 > 0) {
                        simplificationStep = `= ${formatCoeff(compositeCoeff)}x + ${distributedTerm} + ${b1}`;
                    } else if (distributedTerm < 0 && b1 < 0) {
                        simplificationStep = `= ${formatCoeff(compositeCoeff)}x - ${Math.abs(distributedTerm)} - ${Math.abs(b1)}`;
                    } else if (distributedTerm > 0 && b1 < 0) {
                        simplificationStep = `= ${formatCoeff(compositeCoeff)}x + ${distributedTerm} - ${Math.abs(b1)}`;
                    } else if (distributedTerm < 0 && b1 > 0) {
                        simplificationStep = `= ${formatCoeff(compositeCoeff)}x - ${Math.abs(distributedTerm)} + ${b1}`;
                    }
                }
                
                const steps = [
                    `\\textbf{Diketahui:} \\quad f(x) = ${f} \\text{ dan } g(x) = ${g}`,
                    `\\textbf{Ditanya:} \\quad (f \\circ g)(x) = ?`,
                    `\\textbf{Penyelesaian:}`,
                    `\\text{Langkah 1: Substitusi } g(x) \\text{ ke dalam } f(x)`,
                    `(f \\circ g)(x) = f(g(x)) = f(${g})`,
                    `\\text{Langkah 2: Ganti } x \\text{ dalam } f(x) \\text{ dengan } g(x)`,
                    `f(${g}) = ${formatCoeff(a1)}(${g})${formatSign(b1)}`,
                    `\\text{Langkah 3: Substitusi nilai } g(x) = ${g}`,
                    `= ${formatCoeff(a1)}(${formatCoeff(a2)}x${formatSign(b2)})${formatSign(b1)}`,
                    `\\text{Langkah 4: Distribusikan koefisien}`,
                    distributionStep,
                    `= ${formatCoeff(compositeCoeff)}x${formatSign(distributedTerm)}${formatSign(b1)}`,
                    ...(simplificationStep ? [`\\text{Langkah 5: Sederhanakan konstanta}`, simplificationStep] : []),
                    `\\textbf{Jadi, } (f \\circ g)(x) = ${answer}`
                ];
                
                return {
                    question: `Jika f(x) = ${f} \\text{ dan } g(x) = ${g}, \\text{ tentukan } (f \\circ g)(x)!`,
                    answer: answer,
                    steps: steps
                };
            },
            
            quadratic: () => {
                // Variasi bentuk fungsi kuadrat
                const quadraticTypes = [
                    // Tipe 1: f(x) = x^2 + b, g(x) = cx
                    () => {
                        const b = Math.floor(Math.random() * 8) + 1;
                        const c = Math.floor(Math.random() * 4) + 1;
                        return {
                            f: `x^2 + ${b}`,
                            g: `${c === 1 ? '' : c}x`,
                            b: b,
                            c: c,
                            type: 'simple'
                        };
                    },
                    // Tipe 2: f(x) = ax^2, g(x) = x + b
                    () => {
                        const a = Math.floor(Math.random() * 3) + 1;
                        const b = Math.floor(Math.random() * 6) + 1;
                        return {
                            f: `${a === 1 ? '' : a}x^2`,
                            g: `x + ${b}`,
                            a: a,
                            b: b,
                            type: 'coefficient'
                        };
                    },
                    // Tipe 3: f(x) = x^2 + bx + c, g(x) = dx
                    () => {
                        const b = Math.floor(Math.random() * 6) - 3;
                        const c = Math.floor(Math.random() * 8) + 1;
                        const d = Math.floor(Math.random() * 3) + 1;
                        return {
                            f: `x^2 ${b >= 0 ? '+' : ''} ${b === 1 ? '' : (b === -1 ? '-' : b)}${b !== 0 ? 'x' : ''} + ${c}`,
                            g: `${d === 1 ? '' : d}x`,
                            b: b,
                            c: c,
                            d: d,
                            type: 'full'
                        };
                    }
                ];
                
                const selectedType = quadraticTypes[Math.floor(Math.random() * quadraticTypes.length)]();
                
                if (selectedType.type === 'simple') {
                    const {f, g, b, c} = selectedType;
                    
                    // (f∘g)(x) = (cx)^2 + b = c^2*x^2 + b
                    const answer = `${c * c === 1 ? '' : c * c}x^2 + ${b}`;
                    
                    const steps = [
                        `\\textbf{Diketahui:} \\quad f(x) = ${f} \\text{ dan } g(x) = ${g}`,
                        `\\textbf{Ditanya:} \\quad (f \\circ g)(x) = ?`,
                        `\\textbf{Penyelesaian:}`,
                        `\\text{Langkah 1: Substitusi } g(x) \\text{ ke dalam } f(x)`,
                        `(f \\circ g)(x) = f(g(x)) = f(${g})`,
                        `\\text{Langkah 2: Ganti } x \\text{ dalam } f(x) \\text{ dengan } g(x)`,
                        `f(${g}) = (${g})^2 + ${b}`,
                        `\\text{Langkah 3: Substitusi nilai } g(x) = ${g}`,
                        `= (${c === 1 ? '' : c}x)^2 + ${b}`,
                        `\\text{Langkah 4: Hitung pangkat}`,
                        `= ${c === 1 ? '' : c}^2 \\cdot x^2 + ${b}`,
                        `= ${c * c === 1 ? '' : c * c}x^2 + ${b}`,
                        `\\textbf{Jadi, } (f \\circ g)(x) = ${c * c === 1 ? '' : c * c}x^2 + ${b}`
                    ];
                    
                    return {
                        question: `Jika f(x) = ${f} \\text{ dan } g(x) = ${g}, \\text{ tentukan } (f \\circ g)(x)!`,
                        answer: answer,
                        steps: steps
                    };
                } else if (selectedType.type === 'coefficient') {
                    const {f, g, a, b} = selectedType;
                    
                    // (f∘g)(x) = a(x + b)^2 = a(x^2 + 2bx + b^2) = ax^2 + 2abx + ab^2
                    const formatQuadratic = (coeff1, coeff2, const1) => {
                        let result = `${coeff1 === 1 ? '' : coeff1}x^2`;
                        if (coeff2 !== 0) {
                            result += coeff2 > 0 ? ` + ${coeff2 === 1 ? '' : coeff2}x` : ` - ${Math.abs(coeff2) === 1 ? '' : Math.abs(coeff2)}x`;
                        }
                        if (const1 !== 0) {
                            result += const1 > 0 ? ` + ${const1}` : ` - ${Math.abs(const1)}`;
                        }
                        return result;
                    };
                    
                    const answer = formatQuadratic(a, 2*a*b, a*b*b);
                    
                    const steps = [
                        `\\textbf{Diketahui:} \\quad f(x) = ${f} \\text{ dan } g(x) = ${g}`,
                        `\\textbf{Ditanya:} \\quad (f \\circ g)(x) = ?`,
                        `\\textbf{Penyelesaian:}`,
                        `\\text{Langkah 1: Substitusi } g(x) \\text{ ke dalam } f(x)`,
                        `(f \\circ g)(x) = f(g(x)) = f(${g})`,
                        `\\text{Langkah 2: Ganti } x \\text{ dalam } f(x) \\text{ dengan } g(x)`,
                        `f(${g}) = ${a === 1 ? '' : a}(${g})^2`,
                        `\\text{Langkah 3: Substitusi nilai } g(x) = ${g}`,
                        `= ${a === 1 ? '' : a}(x + ${b})^2`,
                        `\\text{Langkah 4: Ekspansi } (x + ${b})^2 = x^2 + 2 \\cdot ${b} \\cdot x + ${b}^2`,
                        `= ${a === 1 ? '' : a}(x^2 + ${2*b}x + ${b*b})`,
                        `\\text{Langkah 5: Distribusikan koefisien } ${a === 1 ? '' : a}`,
                        `= ${a === 1 ? '' : a} \\cdot x^2 + ${a === 1 ? '' : a} \\cdot ${2*b}x + ${a === 1 ? '' : a} \\cdot ${b*b}`,
                        `= ${answer}`,
                        `\\textbf{Jadi, } (f \\circ g)(x) = ${answer}`
                    ];
                    
                    return {
                        question: `Jika f(x) = ${f} \\text{ dan } g(x) = ${g}, \\text{ tentukan } (f \\circ g)(x)!`,
                        answer: answer,
                        steps: steps
                    };
                } else {
                    const {f, g, b, c, d} = selectedType;
                    
                    // (f∘g)(x) = (dx)^2 + b(dx) + c = d^2*x^2 + bd*x + c
                    const formatFullQuadratic = (coeff1, coeff2, const1) => {
                        let result = `${coeff1 === 1 ? '' : coeff1}x^2`;
                        if (coeff2 !== 0) {
                            if (coeff2 > 0) {
                                result += ` + ${coeff2 === 1 ? '' : coeff2}x`;
                            } else {
                                result += ` - ${Math.abs(coeff2) === 1 ? '' : Math.abs(coeff2)}x`;
                            }
                        }
                        if (const1 !== 0) {
                            result += const1 > 0 ? ` + ${const1}` : ` - ${Math.abs(const1)}`;
                        }
                        return result;
                    };
                    
                    const answer = formatFullQuadratic(d*d, b*d, c);
                    
                    const steps = [
                        `\\textbf{Diketahui:} \\quad f(x) = ${f} \\text{ dan } g(x) = ${g}`,
                        `\\textbf{Ditanya:} \\quad (f \\circ g)(x) = ?`,
                        `\\textbf{Penyelesaian:}`,
                        `\\text{Langkah 1: Substitusi } g(x) \\text{ ke dalam } f(x)`,
                        `(f \\circ g)(x) = f(g(x)) = f(${g})`,
                        `\\text{Langkah 2: Ganti } x \\text{ dalam } f(x) \\text{ dengan } g(x)`,
                        `f(${g}) = (${g})^2 ${b >= 0 ? '+' : ''} ${b === 1 ? '' : (b === -1 ? '-' : b)}${b !== 0 ? `(${g})` : ''} + ${c}`,
                        `\\text{Langkah 3: Substitusi nilai } g(x) = ${g}`,
                        `= (${d === 1 ? '' : d}x)^2 ${b >= 0 ? '+' : ''} ${b === 1 ? '' : (b === -1 ? '-' : b)}${b !== 0 ? `(${d === 1 ? '' : d}x)` : ''} + ${c}`,
                        `\\text{Langkah 4: Hitung setiap suku}`,
                        `= ${d*d === 1 ? '' : d*d}x^2 ${b*d >= 0 ? '+' : ''} ${Math.abs(b*d) === 1 ? (b*d >= 0 ? '' : '-') : (b*d >= 0 ? b*d : b*d)}${b !== 0 ? 'x' : ''} + ${c}`,
                        `\\textbf{Jadi, } (f \\circ g)(x) = ${answer}`
                    ];
                    
                    return {
                        question: `Jika f(x) = ${f} \\text{ dan } g(x) = ${g}, \\text{ tentukan } (f \\circ g)(x)!`,
                        answer: answer,
                        steps: steps
                    };
                }
            },
            
            rational: () => {
                const a = Math.floor(Math.random() * 5) + 1;
                const b = Math.floor(Math.random() * 5) + 1;
                const c = Math.floor(Math.random() * 3) + 1;
                const d = Math.floor(Math.random() * 5) + 1;
                
                // Helper function to format coefficient
                const formatCoeff = (coeff) => {
                    if (coeff === 1) return '';
                    if (coeff === -1) return '-';
                    return coeff;
                };
                
                const f = `\\frac{${formatCoeff(a)}x + ${b}}{${c}}`;
                const g = `x + ${d}`;
                
                const answer = `\\frac{${formatCoeff(a)}x + ${a * d + b}}{${c}}`;
                
                const steps = [
                    `\\textbf{Diketahui:} \\quad f(x) = ${f} \\text{ dan } g(x) = ${g}`,
                    `\\textbf{Ditanya:} \\quad (f \\circ g)(x) = ?`,
                    `\\textbf{Penyelesaian:}`,
                    `\\text{Langkah 1: Substitusi } g(x) \\text{ ke dalam } f(x)`,
                    `(f \\circ g)(x) = f(g(x)) = f(${g})`,
                    `\\text{Langkah 2: Ganti } x \\text{ dalam } f(x) \\text{ dengan } g(x)`,
                    `f(${g}) = \\frac{${formatCoeff(a)}(${g}) + ${b}}{${c}}`,
                    `\\text{Langkah 3: Substitusi nilai } g(x) = ${g}`,
                    `= \\frac{${formatCoeff(a)}(x + ${d}) + ${b}}{${c}}`,
                    `\\text{Langkah 4: Distribusikan koefisien di pembilang}`,
                    `= \\frac{${formatCoeff(a)} \\cdot x + ${formatCoeff(a)} \\cdot ${d} + ${b}}{${c}}`,
                    `= \\frac{${formatCoeff(a)}x + ${a * d} + ${b}}{${c}}`,
                    `\\text{Langkah 5: Sederhanakan pembilang}`,
                    `= \\frac{${formatCoeff(a)}x + ${a * d + b}}{${c}}`,
                    `\\textbf{Jadi, } (f \\circ g)(x) = ${answer}`
                ];
                
                return {
                    question: `Jika f(x) = ${f} \\text{ dan } g(x) = ${g}, \\text{ tentukan } (f \\circ g)(x)!`,
                    answer: answer,
                    steps: steps
                };
            },
            
            exponential: () => {
                const base = Math.floor(Math.random() * 3) + 2;
                const coeff = Math.floor(Math.random() * 3) + 1;
                const const1 = Math.floor(Math.random() * 5) + 1;
                
                // Helper function to format coefficient
                const formatCoeff = (coeff) => {
                    if (coeff === 1) return '';
                    if (coeff === -1) return '-';
                    return coeff;
                };
                
                // Helper function to format sign and number
                const formatSign = (num) => {
                    if (num === 0) return '';
                    if (num > 0) return ` + ${num}`;
                    if (num < 0) return ` - ${Math.abs(num)}`;
                    return '';
                };
                
                const f = `${base}^x`;
                const g = `${formatCoeff(coeff)}x${formatSign(const1)}`;
                
                const answer = `${base}^{${formatCoeff(coeff)}x${formatSign(const1)}}`;
                
                const steps = [
                    `\\textbf{Diketahui:} \\quad f(x) = ${f} \\text{ dan } g(x) = ${g}`,
                    `\\textbf{Ditanya:} \\quad (f \\circ g)(x) = ?`,
                    `\\textbf{Penyelesaian:}`,
                    `\\text{Langkah 1: Substitusi } g(x) \\text{ ke dalam } f(x)`,
                    `(f \\circ g)(x) = f(g(x)) = f(${g})`,
                    `\\text{Langkah 2: Ganti } x \\text{ dalam } f(x) \\text{ dengan } g(x)`,
                    `f(${g}) = ${base}^{${g}}`,
                    `\\text{Langkah 3: Substitusi nilai } g(x) = ${g}`,
                    `= ${base}^{${formatCoeff(coeff)}x${formatSign(const1)}}`,
                    `\\textbf{Jadi, } (f \\circ g)(x) = ${answer}`
                ];
                
                return {
                    question: `Jika f(x) = ${f} \\text{ dan } g(x) = ${g}, \\text{ tentukan } (f \\circ g)(x)!`,
                    answer: answer,
                    steps: steps
                };
            },
            
            radical: () => {
                const a = Math.floor(Math.random() * 5) + 1;
                const b = Math.floor(Math.random() * 10) + 1;
                const c = Math.floor(Math.random() * 3) + 1;
                
                // Helper function to format coefficient
                const formatCoeff = (coeff) => {
                    if (coeff === 1) return '';
                    if (coeff === -1) return '-';
                    return coeff;
                };
                
                const f = `\\sqrt{x + ${b}}`;
                const g = `${formatCoeff(c)}x`;
                
                const answer = `\\sqrt{${formatCoeff(c)}x + ${b}}`;
                
                const steps = [
                    `\\textbf{Diketahui:} \\quad f(x) = ${f} \\text{ dan } g(x) = ${g}`,
                    `\\textbf{Ditanya:} \\quad (f \\circ g)(x) = ?`,
                    `\\textbf{Penyelesaian:}`,
                    `\\text{Langkah 1: Substitusi } g(x) \\text{ ke dalam } f(x)`,
                    `(f \\circ g)(x) = f(g(x)) = f(${g})`,
                    `\\text{Langkah 2: Ganti } x \\text{ dalam } f(x) \\text{ dengan } g(x)`,
                    `f(${g}) = \\sqrt{${g} + ${b}}`,
                    `\\text{Langkah 3: Substitusi nilai } g(x) = ${g}`,
                    `= \\sqrt{${formatCoeff(c)}x + ${b}}`,
                    `\\textbf{Jadi, } (f \\circ g)(x) = ${answer}`
                ];
                
                return {
                    question: `Jika f(x) = ${f} \\text{ dan } g(x) = ${g}, \\text{ tentukan } (f \\circ g)(x)!`,
                    answer: answer,
                    steps: steps
                };
            }
        };

        function generateQuestions() {
            const checkboxes = document.querySelectorAll('input[name="functionType"]:checked');
            selectedFunctionTypes = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedFunctionTypes.length === 0) {
                alert('Pilih minimal satu bentuk fungsi!');
                return;
            }
            
            if (selectedFunctionTypes.includes('mixed')) {
                selectedFunctionTypes = ['linear', 'quadratic', 'rational', 'exponential', 'radical'];
            }
            
            questions = [];
            answers = [];
            
            for (let i = 0; i < 10; i++) {
                const randomType = selectedFunctionTypes[Math.floor(Math.random() * selectedFunctionTypes.length)];
                const questionData = functionGenerators[randomType]();
                questions.push(questionData);
                answers.push('');
            }
            
            displayQuestions();
            document.getElementById('functionTypeSelection').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');
            document.getElementById('resultsContainer').classList.add('hidden');
        }

        function displayQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card bg-white rounded-xl shadow-lg p-6 mb-6';
                questionDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Soal ${index + 1}</h3>
                        <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">
                            ${getQuestionType(q.question)}
                        </span>
                    </div>
                    <div class="mb-4 text-gray-700">
                        $${q.question}$
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-600 font-medium">Jawaban:</label>
                        <input type="text" 
                               id="answer_${index}" 
                               class="math-input flex-1 border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-indigo-500 focus:outline-none text-lg"
                               placeholder="Masukkan jawaban..."
                               onfocus="setCurrentInput(this)"
                               oninput="formatMathInputDirect(this)"
                               onkeyup="formatMathInputDirect(this)">
                        <button onclick="showKeyboard('answer_${index}')" 
                                class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-4 py-2 rounded-lg transition-colors">
                            ⌨️ Keyboard
                        </button>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        function getQuestionType(question) {
            if (question.includes('sqrt')) return 'Fungsi Akar';
            if (question.includes('^{') || question.includes('^x')) return 'Fungsi Eksponensial';
            if (question.includes('frac')) return 'Fungsi Rasional';
            if (question.includes('x^2')) return 'Fungsi Kuadrat';
            return 'Fungsi Linear';
        }

        function setCurrentInput(input) {
            currentInputField = input;
        }

        function formatMathInputDirect(input) {
            const cursorPos = input.selectionStart;
            let value = input.value;
            let newCursorPos = cursorPos;
            
            // Replace common math symbols with proper Unicode
            const symbolReplacements = {
                '*': '×',
                'x': '×',  // when used as multiplication
                '·': '⋅',
                'dot': '⋅',
                '/': '÷',
                '+-': '±',
                '-+': '±',
                '!=': '≠',
                '<=': '≤',
                '>=': '≥',
                'pi': 'π',
                'infinity': '∞',
                'inf': '∞'
            };
            
            // Apply symbol replacements
            Object.keys(symbolReplacements).forEach(key => {
                const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                value = value.replace(regex, symbolReplacements[key]);
            });
            
            // Format pangkat dengan angka: x^2 menjadi x²
            value = value.replace(/([a-zA-Z0-9πe∞]+)\^([0-9]+)/g, (match, base, exp) => {
                const superscripts = {'0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹'};
                return base + exp.split('').map(d => superscripts[d] || d).join('');
            });
            
            // Format pangkat dengan kurung: x^(2x+1) menggunakan superscript Unicode
            value = value.replace(/([a-zA-Z0-9πe∞]+)\^\(([^)]+)\)/g, (match, base, exp) => {
                // Convert expression inside parentheses to superscript
                let superExp = exp.replace(/([a-zA-Z0-9+\-×⋅÷πe∞])/g, (char) => {
                    const superscripts = {
                        '0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹',
                        'x':'ˣ','y':'ʸ','a':'ᵃ','b':'ᵇ','c':'ᶜ','d':'ᵈ','e':'ᵉ','f':'ᶠ','g':'ᵍ','h':'ʰ',
                        'i':'ⁱ','j':'ʲ','k':'ᵏ','l':'ˡ','m':'ᵐ','n':'ⁿ','o':'ᵒ','p':'ᵖ','r':'ʳ','s':'ˢ',
                        't':'ᵗ','u':'ᵘ','v':'ᵛ','w':'ʷ','z':'ᶻ','+':'⁺','−':'⁻','-':'⁻','×':'ˣ','⋅':'⋅','÷':'÷','π':'π','e':'ᵉ','∞':'∞'
                    };
                    return superscripts[char] || char;
                });
                return base + superExp;
            });
            
            // Format akar dengan kurung: sqrt(x+1) menjadi √(x+1)
            value = value.replace(/sqrt\(([^)]*)\)/g, '√($1)');
            
            // Format akar sederhana: sqrt5 atau sqrtx menjadi √5 atau √x
            value = value.replace(/sqrt([a-zA-Z0-9πe∞]+)/g, '√$1');
            
            // Ganti sqrt yang tersisa menjadi √
            value = value.replace(/sqrt/g, '√');
            
            // Format pecahan dengan garis miring yang lebih baik
            value = value.replace(/(\d+)\/(\d+)/g, '$1÷$2');
            
            // Clean up multiple operators
            value = value.replace(/\+\+/g, '+');
            value = value.replace(/−−/g, '+');
            value = value.replace(/××/g, '×');
            value = value.replace(/⋅⋅/g, '⋅');
            value = value.replace(/÷÷/g, '÷');
            
            // Handle negative signs properly
            value = value.replace(/\+−/g, '−');
            value = value.replace(/−\+/g, '−');
            
            // Update input value
            if (input.value !== value) {
                input.value = value;
                // Maintain cursor position
                input.setSelectionRange(newCursorPos, newCursorPos);
            }
            
            const index = input.id.split('_')[1];
            answers[index] = value;
        }

        function showKeyboard(inputId) {
            currentInputField = document.getElementById(inputId);
            document.getElementById('virtualKeyboard').classList.remove('hidden');
        }

        function hideKeyboard() {
            document.getElementById('virtualKeyboard').classList.add('hidden');
            currentInputField = null;
        }

        function insertSymbol(symbol) {
            if (!currentInputField) return;
            
            const cursorPos = currentInputField.selectionStart;
            const textBefore = currentInputField.value.substring(0, cursorPos);
            const textAfter = currentInputField.value.substring(currentInputField.selectionEnd);
            
            let insertText = symbol;
            let newCursorPos = cursorPos + insertText.length;
            
            // Special handling for certain symbols
            if (symbol === 'sqrt') {
                insertText = '√';
                newCursorPos = cursorPos + 1;
            } else if (symbol === '^2') {
                insertText = '²';
                newCursorPos = cursorPos + 1;
            } else if (symbol === '^3') {
                insertText = '³';
                newCursorPos = cursorPos + 1;
            } else if (symbol === '^') {
                insertText = '^';
                newCursorPos = cursorPos + 1;
            }
            
            currentInputField.value = textBefore + insertText + textAfter;
            currentInputField.setSelectionRange(newCursorPos, newCursorPos);
            currentInputField.focus();
            
            // Trigger formatting
            formatMathInputDirect(currentInputField);
        }
        
        function backspaceInput() {
            if (!currentInputField) return;
            
            const cursorPos = currentInputField.selectionStart;
            if (cursorPos > 0) {
                const textBefore = currentInputField.value.substring(0, cursorPos - 1);
                const textAfter = currentInputField.value.substring(currentInputField.selectionEnd);
                
                currentInputField.value = textBefore + textAfter;
                currentInputField.setSelectionRange(cursorPos - 1, cursorPos - 1);
                currentInputField.focus();
                
                // Trigger formatting
                formatMathInputDirect(currentInputField);
            }
        }

        function clearInput() {
            if (!currentInputField) return;
            currentInputField.value = '';
            formatMathInputDirect(currentInputField);
        }

        function submitQuiz() {
            // Collect all answers
            for (let i = 0; i < 10; i++) {
                const input = document.getElementById(`answer_${i}`);
                answers[i] = input.value.trim();
            }
            
            // Calculate score
            let correctCount = 0;
            const results = [];
            
            questions.forEach((q, index) => {
                const userAnswer = answers[index].toLowerCase().replace(/\s+/g, '');
                const correctAnswer = q.answer.toLowerCase().replace(/\s+/g, '');
                const isCorrect = userAnswer === correctAnswer || 
                                 normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer);
                
                if (isCorrect) correctCount++;
                
                results.push({
                    question: q.question,
                    userAnswer: answers[index],
                    correctAnswer: q.answer,
                    isCorrect: isCorrect,
                    steps: q.steps
                });
            });
            
            const score = (correctCount / 10) * 100;
            displayResults(score, results);
        }

        function normalizeAnswer(answer) {
            // Normalize mathematical expressions for comparison
            return answer
                .replace(/\s+/g, '')
                // Normalize multiplication symbols
                .replace(/×/g, '*')
                .replace(/⋅/g, '*')
                .replace(/\*/g, '')
                // Normalize division symbols
                .replace(/÷/g, '/')
                // Normalize minus signs
                .replace(/−/g, '-')
                // Normalize plus-minus
                .replace(/±/g, '+-')
                // Normalize superscripts to regular notation
                .replace(/²/g, '^2')
                .replace(/³/g, '^3')
                .replace(/⁰/g, '^0')
                .replace(/¹/g, '^1')
                .replace(/⁴/g, '^4')
                .replace(/⁵/g, '^5')
                .replace(/⁶/g, '^6')
                .replace(/⁷/g, '^7')
                .replace(/⁸/g, '^8')
                .replace(/⁹/g, '^9')
                // Normalize square root
                .replace(/√/g, 'sqrt')
                // Clean up operators
                .replace(/\+\+/g, '+')
                .replace(/--/g, '+')
                .replace(/\+-/g, '-')
                .replace(/-\+/g, '-')
                // Remove spaces around operators
                .replace(/\s*\+\s*/g, '+')
                .replace(/\s*-\s*/g, '-')
                .replace(/\s*\*\s*/g, '*')
                .replace(/\s*\/\s*/g, '/')
                .replace(/\s*\^\s*/g, '^');
        }

        function displayResults(score, results) {
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');
            
            const resultTitle = document.getElementById('resultTitle');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const scoreText = document.getElementById('scoreText');
            
            if (score >= 70) {
                resultTitle.textContent = '🎉 Selamat! Anda LULUS!';
                resultTitle.className = 'text-3xl font-bold text-center mb-6 text-green-600';
                scoreDisplay.className = 'text-6xl font-bold mb-2 text-green-600';
            } else {
                resultTitle.textContent = '📚 Perlu Belajar Lagi';
                resultTitle.className = 'text-3xl font-bold text-center mb-6 text-red-600';
                scoreDisplay.className = 'text-6xl font-bold mb-2 text-red-600';
            }
            
            scoreDisplay.textContent = Math.round(score);
            scoreText.textContent = `${Math.round(score)}/100 • ${results.filter(r => r.isCorrect).length}/10 soal benar • KKM: 70`;
            
            // Display detailed results
            const detailedResults = document.getElementById('detailedResults');
            detailedResults.innerHTML = results.map((result, index) => `
                <div class="mb-8 p-6 border-2 ${result.isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'} rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold">Soal ${index + 1}</h4>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${result.isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                            ${result.isCorrect ? '✓ Benar' : '✗ Salah'}
                        </span>
                    </div>
                    <div class="mb-3">
                        <strong>Soal:</strong> $${result.question}$
                    </div>
                    <div class="mb-3">
                        <strong>Jawaban Anda:</strong> $${result.userAnswer || 'Tidak dijawab'}$
                    </div>
                    <div class="mb-4">
                        <strong>Jawaban Benar:</strong> $${result.correctAnswer}$
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <strong>Langkah Penyelesaian:</strong>
                            <button onclick="toggleSteps(${index})" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                <span id="toggleText_${index}">Tampilkan Langkah</span>
                            </button>
                        </div>
                        <div id="steps_${index}" class="hidden">
                            <ol class="list-decimal list-inside mt-2 space-y-1">
                                ${result.steps.map(step => `<li>$${step}$</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        function resetQuiz() {
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('functionTypeSelection').classList.remove('hidden');
            questions = [];
            answers = [];
            
            // Reset checkboxes
            document.querySelectorAll('input[name="functionType"]').forEach(cb => cb.checked = false);
        }



        // Toggle steps visibility
        function toggleSteps(index) {
            const stepsDiv = document.getElementById(`steps_${index}`);
            const toggleText = document.getElementById(`toggleText_${index}`);
            
            if (stepsDiv.classList.contains('hidden')) {
                stepsDiv.classList.remove('hidden');
                toggleText.textContent = 'Sembunyikan Langkah';
            } else {
                stepsDiv.classList.add('hidden');
                toggleText.textContent = 'Tampilkan Langkah';
            }
            
            // Re-render MathJax for the newly shown content
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // Close keyboard when clicking outside
        document.addEventListener('click', function(e) {
            const keyboard = document.getElementById('virtualKeyboard');
            if (!keyboard.contains(e.target) && !e.target.closest('button[onclick*="showKeyboard"]')) {
                hideKeyboard();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96b37dee824ae794',t:'MTc1NDUzNTI5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
